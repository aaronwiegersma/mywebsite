<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reset Password • DocsApp</title>
  <link rel="stylesheet" href="/style.css" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script defer src="/scripts/auth.js"></script>
</head>
<body>
  <main class="container" style="max-width:520px;padding:2rem 0">
    <h1>Reset your password</h1>
    <p class="muted">Enter a new password below.</p>

    <div id="msg" style="display:none"></div>

    <form id="reset-form" style="display:grid;gap:.75rem">
      <input id="newpass" type="password" class="input" placeholder="New password" required />
      <button class="button primary" type="submit">Update password</button>
    </form>
  </main>

  <script>
    (async () => {
      // Parse access token (Supabase sends tokens in the URL hash)
      const hash = new URLSearchParams(location.hash.replace('#',''));
      const access_token = hash.get('access_token');

      const msg = document.getElementById('msg');
      const form = document.getElementById('reset-form');
      const input = document.getElementById('newpass');

      function show(kind, text){
        msg.style.display='block';
        msg.style.padding='.7rem 1rem';
        msg.style.borderRadius='10px';
        msg.style.margin='0 0 .75rem';
        if(kind==='error'){ msg.style.background='#fef2f2'; msg.style.border='1px solid #fecaca'; msg.style.color='#991b1b'; }
        else { msg.style.background='#ecfdf5'; msg.style.border='1px solid #bbf7d0'; msg.style.color='#065f46'; }
        msg.textContent = text;
      }

      if (!access_token) {
        show('error','Missing token. Open the link from your email again.');
        form.style.display = 'none';
        return;
      }

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        try {
          // Use the token from the email to authenticate this browser
          await sb.auth.setSession({ access_token, refresh_token: hash.get('refresh_token') });
          const { error } = await sb.auth.updateUser({ password: input.value });
          if (error) throw error;
          show('success','Password updated. Redirecting to login…');
          setTimeout(()=>location.href='/login.html', 1200);
        } catch (err) {
          show('error', err.message || 'Could not update password.');
        }
      });
    })();
  </script>
</body>
</html>
